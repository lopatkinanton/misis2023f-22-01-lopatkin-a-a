# AstMarker [https://github.com/vchkz/astmarker]

[[Командный репозиторий](https://github.com/vchkz/astmarker)] | [[Личный репозиторий](https://github.com/lopatkinanton/misis2023f-22-01-lopatkin-a-a)]
## Описание проекта 
AstMarker - программа с пользовательским интерфейсом для полуавтоматической разметки соответствующих пар точек на двух картинках, которые являются разными развертками одного 3д-объекта. 
Пример разметки точек приведен на картинке ниже: первое изображение - идеальная развертка, второе - искаженная.
![[prj.cw/data/readmeimg1.png|600]]
Программа помогает размечать точки автоматически. После отметки точки на одной картинке алгоритм пересчета координат "предскажет" расположение соответствующей точки на другой картинке. Пользователь может уточнить положение точки после "предсказания".
Также программа позволяет накладывать картинки друг на друга по размеченным точкам и рассчитывать значения функций ошибок искажения.
## Описание индивидуальной задачи
Разработка библиотеки "Asterisms" для работы с созвездиями, в которой реализованы: 
- добавление точек в созвездие;
- перемещение точек в созвездии;
- удаление точек из созвездия;
- загрузка точек из текстового файла;
- сохранение точек в текстовый файл;
- функция "предсказания" парной точки.

Созвездие представляет собой устойчивую конфигурацию точек на плоскости. Точки разбивают плоскость на треугольники в соответствии с триангуляцией Делоне.
Алгоритм вычисления координат парной точки основывается на интерполяции по вершинам треугольника, внутри которого лежит вновь отмеченная точка. 
На картинках ниже красным цветом показана триангуляция размеченных точек. На левой картинке зеленым цветом обозначена вновь отмеченная точка, синим - треугольник, в котором она лежит. На правой картинке синим цветом обозначен соответствующий треугольник в другом созвездии, и зеленым - результат интерполяции.
![[prj.cw/data/readmeimg2.png|600]]
## Пользовательская документация библиотеки
##### Класс Asterism
Конструкторы:
- Asterism(cv::Rect rect) 
- Asterism(int width, int height)
Все точки созвездия находятся внутри rect или внутри прямоугольника размером width x height.

Поля:
- cv::Subdiv2d subdiv - хранит вершины (все отмеченные точки + точки в углах заданной прямоугольной плоскости) и ребра, разбивающие область на треугольники в соответствии с триангуляцией Делоне
  
Методы:
- void loadPts(std::string path) - загружает точки из файла с расширение .txt
	Параметры:
	std::string path - путь до текстового файла
- void savePts(std::string path) - сохраняет точки в файл с расширением .txt
	Параметры:
	std::string path - путь до текстового файла
- int insertPt(cv::Point pt) - добавляет точку в созвездие и возвращает ее индекс во внутренней структуре данных
    Параметры:
	cv::Point pt - новая точка
- void movePt(int idx, cv::Point newCoords) - изменяет координаты точки 
    Параметры:
	int idx - индекс точки во внутренней структуре данных (его можно получить из функций insert и findNearestPt)
	cv::Point newCoords - новые координаты точки
- void deletePt(int idx) - удаляет точку из созвездия
	Параметры:
	int idx - индекс точки во внутренней структуре данных (его можно получить из функций insert и findNearestPt)
- int findNearestPt(cv::Point pt) - возвращает индекс точки созвездия, ближайшей к данной
    Параметры:
	cv::Point pt - точка, для которой необходимо найти ближайшую
- cv::Point getCoords(int idx) - возвращает координаты точки по заданному индексу
    Параметры:
	int idx - индекс точки во внутренней структуре данных
- cv::Point predictPairedPt(cv::Point pt, Asterism pairedAst) - возвращает предполагаемые координаты точки в парном созвездии, соответствующей переданной
    Параметры:
	cv::Point pt - точка, относящаяся к созвездию для которого вызывается метод
	Asterism pairedAst - парное созвездие, в котором такое же количество точек, как и в том, для которого вызывается метод
- void getPtsToDraw(std::vector<cv::Point> pts) - записывает в массив все точки созвездия, отмеченные на текущий момент
    Параметры:
	std::vector<cv::Point> pts - массив для записи точек	
## Примеры использования
В контексте общей задачи библиотека применяется для работы с двумя созвездиями. Типовой вариант использования:
```С++ 
#include <asterisms/asterisms.hpp>
#include <opencv2/core/core.hpp>

int main(int argc, char** argv) {
	//создание двух созвездий на плоскости размером 256x256
    int n = 256;
    Asterism leftAst(n, n);
    Asterism rightAst(n, n);
    
    //загрузка точек из текстового файла
	leftAst.loadPts("./data/left_points.txt");
	rightAst.loadPts("./data/right_points.txt");

	int ptRadius = 5; //радиус отрисовки точек в графическом интерфейсе
	cv::Point clickedPt(34, 112); //зафиксированный клик по левому изображению
	
	//индекс точки, ближайшей к координатам клика
	int idx = leftAst.findNearestPt(clickedPt); 
	//координаты ближайшей точки
	cv::Point nearestPt = leftAst.getCoords(idx); 
	
	if (cv::norm(nearestPt - clickedPt) < ptRadius) {
		//если выбрана уже существующая точка, 
		//то ее можно подвинуть или удалить (вместе с ее парой)
        leftAst.movePt(idx, cv::Point(115, 112)); 
        leftAst.deletePt(idx);
        rightAst.deletePt(idx);
    }
    else {
	    //иначе - вычислить координаты парной точки и добавить новую пару в созвездия
	    cv::Point pairedPt = leftAst.predictPairedPt(clickedPt, rightAst);
	    leftAst.insertPt(clickedPt);
	    rightAst.insertPt(pairedPt);
    }

	//получение массива отмеченных точек
	std::vector<cv::Point> pts;
	leftAst.getPtsToDraw(pts);
	
	//сохранение точек в текстовый файл
	leftAst.savePts("./data/left_points.txt");
	rightAst.savePts("./data/right_points.txt");
}
```